# 跨角色消息共享机制设计

## 问题描述
当前PhoneSim的消息系统存在数据隔离问题：
- 角色A发送给角色B的消息只存储在角色A的世界书中
- 角色B切换后无法看到角色A发送的消息
- 需要实现跨角色的消息可见性

## 解决方案

### 1. 双向消息存储机制
当角色A向角色B发送消息时，需要同时在两个世界书中存储消息：
- **发送者世界书**：存储在角色A的世界书中（现有机制）
- **接收者世界书**：同时存储在角色B的世界书中（新增机制）

### 2. 消息同步策略
- **发送时同步**：消息发送时立即写入接收者的世界书
- **角色切换时同步**：角色切换时检查并同步未读消息
- **消息状态管理**：维护消息的已读/未读状态

### 3. 实现方案

#### 3.1 修改消息提交函数
在 `commitStagedActions` 函数中：
1. 识别跨角色消息（发送者和接收者是不同角色）
2. 为每条跨角色消息执行双向存储
3. 在接收者的世界书中创建对应的联系人记录（如果不存在）

#### 3.2 新增跨角色数据写入函数
```javascript
async function _updateCrossCharacterWorldbook(targetCharacterName, dbName, updaterFn)
```
- 临时切换到目标角色的世界书
- 执行数据更新操作
- 恢复到当前角色的世界书

#### 3.3 消息同步检查机制
在角色切换时：
1. 检查是否有来自其他角色的新消息
2. 更新未读消息计数
3. 触发UI重新渲染

### 4. 数据结构设计

#### 4.1 消息对象扩展
```javascript
{
  uid: "unique_id",
  timestamp: "2024-01-01T12:00:00Z",
  sender_id: "PLAYER_USER", // 发送者ID
  receiver_id: "contact_123", // 接收者ID（新增）
  sender_character: "角色A", // 发送者角色名（新增）
  receiver_character: "角色B", // 接收者角色名（新增）
  content: { type: "text", text: "消息内容" },
  sourceMsgId: "msg_123",
  isSystemNotification: false,
  isCrossCharacter: true // 跨角色消息标识（新增）
}
```

#### 4.2 角色映射表
维护一个角色到联系人的映射关系：
```javascript
// 存储在特殊的世界书条目中
{
  "character_mapping": {
    "角色A": "contact_123",
    "角色B": "contact_456"
  }
}
```

### 5. 实现步骤

1. **步骤1**：修改 `commitStagedActions` 函数，添加跨角色消息检测
2. **步骤2**：实现 `_updateCrossCharacterWorldbook` 函数
3. **步骤3**：修改消息存储逻辑，支持双向存储
4. **步骤4**：修改角色切换逻辑，添加消息同步检查
5. **步骤5**：更新UI渲染逻辑，正确显示跨角色消息

### 6. 技术考虑

#### 6.1 性能优化
- 批量处理跨角色消息，减少世界书操作次数
- 缓存角色映射关系，避免重复查询
- 异步处理消息同步，不阻塞主流程

#### 6.2 数据一致性
- 使用事务性操作，确保双向存储的原子性
- 添加错误处理和回滚机制
- 定期检查和修复数据不一致问题

#### 6.3 向后兼容性
- 保持现有消息格式的兼容性
- 渐进式升级，不影响现有功能
- 添加版本标识，支持数据迁移

### 7. 测试计划

1. **单元测试**：测试跨角色消息存储和读取
2. **集成测试**：测试角色切换时的消息同步
3. **用户测试**：验证完整的用户体验流程
4. **性能测试**：确保跨角色消息不影响系统性能

## 预期效果

实现后，用户将能够：
1. 角色A发送消息给角色B
2. 切换到角色B后能看到角色A发送的消息
3. 消息状态（已读/未读）正确同步
4. 保持现有功能的完整性和稳定性