<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§’è‰²é€‰æ‹©å™¨æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .test-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .test-button:hover {
            background-color: #2980b9;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background-color: #ecf0f1;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        .log-output {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .character-selector {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ­ è§’è‰²é€‰æ‹©å™¨æµ‹è¯•</h1>
        
        <div class="character-selector">
            <h3>è§’è‰²é€‰æ‹©å™¨</h3>
            <div id="characterSelectorContainer"></div>
        </div>
        
        <div>
            <button class="test-button" onclick="loadTestData()">åŠ è½½æµ‹è¯•æ•°æ®</button>
            <button class="test-button" onclick="testCharacterSelector()">æµ‹è¯•è§’è‰²é€‰æ‹©å™¨</button>
            <button class="test-button" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div class="result">
            <h3>ğŸ“ æµ‹è¯•æ—¥å¿—</h3>
            <div id="logOutput" class="log-output"></div>
        </div>
    </div>

    <!-- å¼•å…¥è§’è‰²é€‰æ‹©å™¨æ¨¡å— -->
    <script type="module">
        import { PhoneSim_State } from './modules/state.js';
        import { CharacterSelector } from './modules/ui_modules/characterSelector.js';
        
        // å°†æ¨¡å—æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸä»¥ä¾¿æµ‹è¯•
        window.PhoneSim_State = PhoneSim_State;
        window.CharacterSelector = CharacterSelector;
        
        // æ¨¡æ‹Ÿ SillyTavern API
        window.SillyTavern_Main_API = {
            getContext: () => ({
                name2: 'å½“å‰è§’è‰²'
            })
        };
        
        window.TavernHelper_API = {
            getChatMessages: () => [
                { content: 'ä½ å¥½ï¼Œæˆ‘æ˜¯å°æ˜', is_user: false },
                { content: 'å¾ˆé«˜å…´è®¤è¯†ä½ ', is_user: true },
                { content: 'æåä¹Ÿåœ¨è¿™é‡Œ', is_user: false }
            ]
        };
        
        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            logOutput.textContent += `[${timestamp}] ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
            console.log(message);
        }
        
        function clearLogs() {
            document.getElementById('logOutput').textContent = '';
        }
        
        // åŠ è½½æµ‹è¯•æ•°æ®
        function loadTestData() {
            // æ¨¡æ‹Ÿä¸–ç•Œä¹¦æ•°æ®
            window.PhoneSim_Data = {
                contacts: {
                    "18555566946": {
                        profile: {
                            nickname: "éƒ­è•¾",
                            note: "ç©ºå§åŒäº‹"
                        }
                    },
                    "13910284576": {
                        profile: {
                            nickname: "å°è•¾",
                            note: "å¥½æœ‹å‹"
                        }
                    },
                    "13812345678": {
                        profile: {
                            nickname: "ç§‹æ€¡",
                            note: "å®¤å‹"
                        }
                    },
                    "18612345678": {
                        profile: {
                            nickname: "è€å…¬",
                            note: "çˆ±äºº"
                        }
                    },
                    "13888888888": {
                        profile: {
                            nickname: "åæ˜¥",
                            note: "ç»ç†"
                        }
                    }
                },
                messages: {
                    "18555566946": [
                        {
                            sender_id: "18555566946",
                            content: "ä»Šå¤©çš„èˆªç­æ€ä¹ˆæ ·ï¼Ÿ",
                            timestamp: 1640995200000
                        }
                    ]
                }
            };
            
            log('âœ… æµ‹è¯•æ•°æ®å·²åŠ è½½');
            log(`ğŸ“ è”ç³»äººæ•°é‡: ${Object.keys(window.PhoneSim_Data.contacts).length}`);
        }
        
        // æµ‹è¯•è§’è‰²é€‰æ‹©å™¨
        async function testCharacterSelector() {
            try {
                log('ğŸ” å¼€å§‹æµ‹è¯•è§’è‰²é€‰æ‹©å™¨');
                
                // åˆ›å»ºè§’è‰²é€‰æ‹©å™¨å®¹å™¨
                const container = document.getElementById('characterSelectorContainer');
                container.innerHTML = `
                    <div class="character-selector-wrapper">
                        <div class="character-selector-button" id="characterSelectorButton">
                            <span id="currentCharacterName">é€‰æ‹©è§’è‰²</span>
                            <span class="dropdown-arrow">â–¼</span>
                        </div>
                        <div class="character-dropdown" id="characterDropdown" style="display: none;">
                            <div class="character-list" id="characterList"></div>
                        </div>
                    </div>
                `;
                
                // åˆå§‹åŒ–è§’è‰²é€‰æ‹©å™¨
                await CharacterSelector.init();
                log('âœ… è§’è‰²é€‰æ‹©å™¨åˆå§‹åŒ–å®Œæˆ');
                
                // æµ‹è¯•è·å–æ‰€æœ‰è§’è‰²
                const characters = await CharacterSelector.getAllCharacters();
                log(`ğŸ­ è·å–åˆ° ${characters.length} ä¸ªè§’è‰²:`);
                characters.forEach(char => {
                    const sources = [];
                    if (char.isCurrent) sources.push('å½“å‰');
                    if (char.fromChat) sources.push('èŠå¤©');
                    if (char.fromWorldBook) sources.push('ä¸–ç•Œä¹¦');
                    if (char.fromSillyTavern) sources.push('SillyTavern');
                    log(`  - ${char.name} (æ¥æº: ${sources.join(', ')})`);
                });
                
                // æµ‹è¯•ä¸–ç•Œä¹¦æå–
                const worldBookCharacters = await CharacterSelector.extractCharactersFromWorldBook();
                log(`ğŸŒ ä»ä¸–ç•Œä¹¦æå–åˆ° ${worldBookCharacters.length} ä¸ªè§’è‰²: ${worldBookCharacters.join(', ')}`);
                
            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
                console.error(error);
            }
        }
        
        // æš´éœ²å‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.log = log;
        window.clearLogs = clearLogs;
        window.loadTestData = loadTestData;
        window.testCharacterSelector = testCharacterSelector;
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('ğŸš€ è§’è‰²é€‰æ‹©å™¨æµ‹è¯•é¡µé¢å·²åŠ è½½');
        });
    </script>
</body>
</html>