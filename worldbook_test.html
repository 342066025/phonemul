<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸–ç•Œä¹¦è§’è‰²æå–æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .test-section h2 {
            color: #2c3e50;
            margin-top: 0;
        }
        .test-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .test-button:hover {
            background-color: #2980b9;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background-color: #ecf0f1;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        .character-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .character-tag {
            background-color: #e74c3c;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
        }
        .character-tag.from-worldbook {
            background-color: #9b59b6;
        }
        .character-tag.from-contacts {
            background-color: #e67e22;
        }
        .character-tag.from-messages {
            background-color: #27ae60;
        }
        .log-output {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ ä¸–ç•Œä¹¦è§’è‰²æå–æµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>ğŸ“‹ æµ‹è¯•æ•°æ®</h2>
            <p>æ¨¡æ‹Ÿä½ æä¾›çš„ä¸–ç•Œä¹¦æ•°æ®ç»“æ„ï¼ŒåŒ…å«è”ç³»äººå’Œæ¶ˆæ¯è®°å½•ã€‚</p>
            <button class="test-button" onclick="loadTestData()">åŠ è½½æµ‹è¯•æ•°æ®</button>
            <button class="test-button" onclick="showTestData()">æ˜¾ç¤ºæµ‹è¯•æ•°æ®</button>
            <div id="testDataResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ­ è§’è‰²æå–æµ‹è¯•</h2>
            <p>æµ‹è¯•ä»ä¸–ç•Œä¹¦æ•°æ®ä¸­æå–è§’è‰²çš„åŠŸèƒ½ã€‚</p>
            <button class="test-button" onclick="testWorldBookExtraction()">æå–ä¸–ç•Œä¹¦è§’è‰²</button>
            <button class="test-button" onclick="testContactsExtraction()">æå–è”ç³»äººè§’è‰²</button>
            <button class="test-button" onclick="testMessagesExtraction()">æå–æ¶ˆæ¯è§’è‰²</button>
            <button class="test-button" onclick="debugDataStructure()">è°ƒè¯•æ•°æ®ç»“æ„</button>
            <div id="extractionResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ“Š æå–ç»“æœ</h2>
            <div id="characterResults" class="character-list"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ“ è°ƒè¯•æ—¥å¿—</h2>
            <button class="test-button" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="logOutput" class="log-output"></div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿä¸–ç•Œä¹¦æ•°æ®
        const testWorldBookData = {
            contacts: {
                "18555566946": {
                    profile: {
                        nickname: "éƒ­è•¾",
                        note: "ç©ºå§åŒäº‹"
                    }
                },
                "13910284576": {
                    profile: {
                        nickname: "å°è•¾",
                        note: "å¥½æœ‹å‹"
                    }
                },
                "13812345678": {
                    profile: {
                        nickname: "ç§‹æ€¡",
                        note: "å®¤å‹"
                    }
                },
                "18612345678": {
                    profile: {
                        nickname: "è€å…¬",
                        note: "çˆ±äºº"
                    }
                },
                "13888888888": {
                    profile: {
                        nickname: "åæ˜¥",
                        note: "ç»ç†"
                    }
                }
            },
            messages: {
                "18555566946": [
                    {
                        sender_id: "18555566946",
                        content: "ä»Šå¤©çš„èˆªç­æ€ä¹ˆæ ·ï¼Ÿ",
                        timestamp: 1640995200000
                    },
                    {
                        sender_id: "PLAYER_USER",
                        content: "è¿˜ä¸é”™ï¼Œä¹˜å®¢éƒ½å¾ˆé…åˆ",
                        timestamp: 1640995260000
                    }
                ],
                "13910284576": [
                    {
                        sender_id: "13910284576",
                        content: "å°è•¾æƒ³çº¦ä½ ä¸€èµ·é€›è¡—",
                        timestamp: 1640995200000
                    }
                ]
            }
        };

        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            logOutput.textContent += `[${timestamp}] ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
            console.log(message);
        }

        function clearLogs() {
            document.getElementById('logOutput').textContent = '';
        }

        // åŠ è½½æµ‹è¯•æ•°æ®
        function loadTestData() {
            window.PhoneSim_Data = testWorldBookData;
            log('âœ… æµ‹è¯•æ•°æ®å·²åŠ è½½åˆ° window.PhoneSim_Data');
            log(`ğŸ“ è”ç³»äººæ•°é‡: ${Object.keys(testWorldBookData.contacts).length}`);
            log(`ğŸ’¬ å¯¹è¯æ•°é‡: ${Object.keys(testWorldBookData.messages).length}`);
        }

        // æ˜¾ç¤ºæµ‹è¯•æ•°æ®
        function showTestData() {
            const result = document.getElementById('testDataResult');
            result.style.display = 'block';
            result.innerHTML = `
                <h3>ğŸ“ è”ç³»äººåˆ—è¡¨</h3>
                <ul>
                    ${Object.entries(testWorldBookData.contacts).map(([phone, contact]) => 
                        `<li><strong>${contact.profile.nickname}</strong> (${phone}) - ${contact.profile.note}</li>`
                    ).join('')}
                </ul>
                <h3>ğŸ’¬ æ¶ˆæ¯è®°å½•</h3>
                <ul>
                    ${Object.entries(testWorldBookData.messages).map(([phone, messages]) => 
                        `<li>${phone}: ${messages.length} æ¡æ¶ˆæ¯</li>`
                    ).join('')}
                </ul>
            `;
        }

        // è§’è‰²æå–å‡½æ•°
        function extractCharactersFromWorldBook() {
            log('ğŸ” å¼€å§‹ä»ä¸–ç•Œä¹¦æå–è§’è‰²');
            const characterNames = new Set();
            
            try {
                // ä»æ‰‹æœºæ¨¡æ‹Ÿå™¨æ•°æ®ä¸­æå–è§’è‰²
                if (window.PhoneSim_Data) {
                    const phoneData = window.PhoneSim_Data;
                    log('ğŸ“± æ‰¾åˆ°æ‰‹æœºæ¨¡æ‹Ÿå™¨æ•°æ®');
                    
                    // ä»è”ç³»äººä¸­æå–è§’è‰²
                    if (phoneData.contacts) {
                        Object.values(phoneData.contacts).forEach(contact => {
                            if (contact && contact.profile) {
                                if (contact.profile.nickname) {
                                    characterNames.add(contact.profile.nickname);
                                    log(`ğŸ‘¤ ä»è”ç³»äººæå–è§’è‰²: ${contact.profile.nickname}`);
                                }
                                if (contact.profile.note && contact.profile.note !== contact.profile.nickname) {
                                    characterNames.add(contact.profile.note);
                                    log(`ğŸ“ ä»è”ç³»äººå¤‡æ³¨æå–è§’è‰²: ${contact.profile.note}`);
                                }
                            }
                        });
                    }
                    
                    // ä»æ¶ˆæ¯è®°å½•ä¸­æå–è§’è‰²
                    if (phoneData.messages) {
                        Object.values(phoneData.messages).forEach(conversation => {
                            if (conversation && Array.isArray(conversation)) {
                                conversation.forEach(message => {
                                    if (message && message.sender_id && message.sender_id !== 'PLAYER_USER') {
                                        // æŸ¥æ‰¾å¯¹åº”çš„è”ç³»äººä¿¡æ¯
                                        const contact = phoneData.contacts && phoneData.contacts[message.sender_id];
                                        if (contact && contact.profile && contact.profile.nickname) {
                                            characterNames.add(contact.profile.nickname);
                                            log(`ğŸ’¬ ä»æ¶ˆæ¯å‘é€è€…æå–è§’è‰²: ${contact.profile.nickname}`);
                                        }
                                    }
                                });
                            }
                        });
                    }
                }
                
            } catch (error) {
                log(`âŒ ä»ä¸–ç•Œä¹¦æå–è§’è‰²æ—¶å‡ºé”™: ${error.message}`);
            }
            
            const result = Array.from(characterNames);
            log(`âœ… ä»ä¸–ç•Œä¹¦æå–åˆ°çš„è§’è‰²: ${result.join(', ')}`);
            return result;
        }

        // æµ‹è¯•å‡½æ•°
        function testWorldBookExtraction() {
            if (!window.PhoneSim_Data) {
                log('âš ï¸ è¯·å…ˆåŠ è½½æµ‹è¯•æ•°æ®');
                return;
            }
            
            const characters = extractCharactersFromWorldBook();
            displayCharacters(characters, 'from-worldbook');
            
            const result = document.getElementById('extractionResult');
            result.style.display = 'block';
            result.innerHTML = `
                <h3>ğŸ­ æå–ç»“æœ</h3>
                <p>ä»ä¸–ç•Œä¹¦æ•°æ®ä¸­æå–åˆ° <strong>${characters.length}</strong> ä¸ªè§’è‰²ï¼š</p>
                <p>${characters.join(', ')}</p>
            `;
        }

        function testContactsExtraction() {
            if (!window.PhoneSim_Data) {
                log('âš ï¸ è¯·å…ˆåŠ è½½æµ‹è¯•æ•°æ®');
                return;
            }
            
            const characters = [];
            Object.values(window.PhoneSim_Data.contacts).forEach(contact => {
                if (contact && contact.profile && contact.profile.nickname) {
                    characters.push(contact.profile.nickname);
                }
            });
            
            displayCharacters(characters, 'from-contacts');
            log(`ğŸ“ ä»è”ç³»äººæå–åˆ° ${characters.length} ä¸ªè§’è‰²: ${characters.join(', ')}`);
        }

        function testMessagesExtraction() {
            if (!window.PhoneSim_Data) {
                log('âš ï¸ è¯·å…ˆåŠ è½½æµ‹è¯•æ•°æ®');
                return;
            }
            
            const characters = new Set();
            Object.values(window.PhoneSim_Data.messages).forEach(conversation => {
                if (conversation && Array.isArray(conversation)) {
                    conversation.forEach(message => {
                        if (message && message.sender_id && message.sender_id !== 'PLAYER_USER') {
                            const contact = window.PhoneSim_Data.contacts[message.sender_id];
                            if (contact && contact.profile && contact.profile.nickname) {
                                characters.add(contact.profile.nickname);
                            }
                        }
                    });
                }
            });
            
            const result = Array.from(characters);
            displayCharacters(result, 'from-messages');
            log(`ğŸ’¬ ä»æ¶ˆæ¯è®°å½•æå–åˆ° ${result.length} ä¸ªè§’è‰²: ${result.join(', ')}`);
        }

        function displayCharacters(characters, className) {
            const container = document.getElementById('characterResults');
            // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
            container.innerHTML = '';
            
            if (characters.length === 0) {
                container.innerHTML = '<p style="color: #e74c3c;">âŒ æ²¡æœ‰æå–åˆ°ä»»ä½•è§’è‰²</p>';
                return;
            }
            
            characters.forEach(char => {
                const tag = document.createElement('div');
                tag.className = `character-tag ${className}`;
                tag.textContent = char;
                container.appendChild(tag);
            });
            
            // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
            const stats = document.createElement('div');
            stats.style.marginTop = '10px';
            stats.style.fontSize = '14px';
            stats.style.color = '#7f8c8d';
            stats.textContent = `å…±æå–åˆ° ${characters.length} ä¸ªè§’è‰²`;
            container.appendChild(stats);
        }

        // è°ƒè¯•æ•°æ®ç»“æ„
        function debugDataStructure() {
            log('ğŸ” å¼€å§‹è°ƒè¯•æ•°æ®ç»“æ„');
            
            if (!window.PhoneSim_Data) {
                log('âŒ window.PhoneSim_Data ä¸å­˜åœ¨');
                return;
            }
            
            log('âœ… window.PhoneSim_Data å­˜åœ¨');
            log(`ğŸ“Š æ•°æ®ç±»å‹: ${typeof window.PhoneSim_Data}`);
            log(`ğŸ“Š æ•°æ®å†…å®¹: ${JSON.stringify(window.PhoneSim_Data, null, 2)}`);
            
            if (window.PhoneSim_Data.contacts) {
                log(`ğŸ“ è”ç³»äººæ•°æ®å­˜åœ¨ï¼Œæ•°é‡: ${Object.keys(window.PhoneSim_Data.contacts).length}`);
                Object.entries(window.PhoneSim_Data.contacts).forEach(([phone, contact]) => {
                    log(`ğŸ“ è”ç³»äºº ${phone}: ${JSON.stringify(contact, null, 2)}`);
                });
            } else {
                log('âŒ è”ç³»äººæ•°æ®ä¸å­˜åœ¨');
            }
            
            if (window.PhoneSim_Data.messages) {
                log(`ğŸ’¬ æ¶ˆæ¯æ•°æ®å­˜åœ¨ï¼Œå¯¹è¯æ•°é‡: ${Object.keys(window.PhoneSim_Data.messages).length}`);
                Object.entries(window.PhoneSim_Data.messages).forEach(([phone, messages]) => {
                    log(`ğŸ’¬ å¯¹è¯ ${phone}: ${messages.length} æ¡æ¶ˆæ¯`);
                });
            } else {
                log('âŒ æ¶ˆæ¯æ•°æ®ä¸å­˜åœ¨');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æµ‹è¯•æ•°æ®
        window.addEventListener('load', () => {
            log('ğŸš€ ä¸–ç•Œä¹¦è§’è‰²æå–æµ‹è¯•é¡µé¢å·²åŠ è½½');
            loadTestData();
        });
    </script>
</body>
</html>